<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redefinir Senha - Protocol Omega 3.0</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="main-container">
        <!-- Efeitos de fundo neon -->
        <div class="background-effects">
            <div class="blur-circle blur-circle-1"></div>
            <div class="blur-circle blur-circle-2"></div>
        </div>
        
        <div class="content-wrapper">
            <!-- Header -->
            <div class="header">
                <div class="logo-container">
                    <div class="logo-glow"></div>
                    <div class="logo-box">
                        <img src="Img.png" alt="Protocol Omega 3.0" class="logo-img">
                    </div>
                </div>
                <h1 class="title">Protocol Omega 3.0</h1>
                <p class="subtitle">Redefini√ß√£o de Senha</p>
            </div>

            <div class="form-container">
                <!-- Conte√∫do da p√°gina -->
                <div class="form-content">
                    <!-- Formul√°rio de redefini√ß√£o -->
                    <div id="resetForm">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <div style="width: 64px; height: 64px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                                <i data-lucide="key" style="width: 32px; height: 32px; color: #60a5fa;"></i>
                            </div>
                            <h2 style="color: #ffffff; margin-bottom: 0.5rem;">Redefinir Senha</h2>
                            <p style="color: #9ca3af;">Digite sua nova senha abaixo</p>
                        </div>

                        <form id="formResetPassword" class="form">
                            <div class="form-group">
                                <label for="newPassword" class="form-label">Nova Senha</label>
                                <div class="input-wrapper">
                                    <i data-lucide="lock" class="input-icon"></i>
                                    <input 
                                        type="password" 
                                        id="newPassword" 
                                        class="form-input" 
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                        required
                                        minlength="6"
                                    >
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="confirmPassword" class="form-label">Confirmar Nova Senha</label>
                                <div class="input-wrapper">
                                    <i data-lucide="lock" class="input-icon"></i>
                                    <input 
                                        type="password" 
                                        id="confirmPassword" 
                                        class="form-input" 
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                        required
                                        minlength="6"
                                    >
                                </div>
                            </div>

                            <button type="submit" class="btn-primary">
                                <i data-lucide="check" class="btn-icon"></i>
                                <span>Atualizar Senha</span>
                            </button>
                        </form>
                    </div>

                    <!-- Mensagem de sucesso -->
                    <div id="successMessage" style="display: none; text-align: center; padding: 2rem 0;">
                        <div style="width: 64px; height: 64px; background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                            <i data-lucide="check-circle" style="width: 32px; height: 32px; color: #4ade80;"></i>
                        </div>
                        <h2 style="color: #ffffff; margin-bottom: 0.5rem;">Senha Atualizada!</h2>
                        <p style="color: #9ca3af; margin-bottom: 1.5rem;">
                            Sua senha foi atualizada com sucesso.
                        </p>
                        <a href="index.html" class="btn-primary" style="display: inline-flex; text-decoration: none; width: auto; padding: 0.75rem 2rem;">
                            <i data-lucide="log-in" class="btn-icon"></i>
                            <span>Fazer Login</span>
                        </a>
                    </div>

                    <!-- Mensagem de erro -->
                    <div id="errorMessage" style="display: none; text-align: center; padding: 2rem 0;">
                        <div style="width: 64px; height: 64px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                            <i data-lucide="x-circle" style="width: 32px; height: 32px; color: #f87171;"></i>
                        </div>
                        <h2 style="color: #ffffff; margin-bottom: 0.5rem;">Link Inv√°lido</h2>
                        <p style="color: #9ca3af; margin-bottom: 1.5rem;">
                            Este link de recupera√ß√£o de senha √© inv√°lido ou j√° expirou.<br>
                            Por favor, solicite um novo link.
                        </p>
                        <a href="index.html" class="btn-primary" style="display: inline-flex; text-decoration: none; width: auto; padding: 0.75rem 2rem;">
                            <i data-lucide="arrow-left" class="btn-icon"></i>
                            <span>Voltar ao Login</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="supabase-auth.js"></script>
    <script>
        // ================================================================================
        // P√ÅGINA DE REDEFINI√á√ÉO DE SENHA
        // ================================================================================
        //
        // Esta p√°gina √© acessada quando o usu√°rio clica no link de recupera√ß√£o
        // enviado por email pelo Supabase.
        //
        // COMO FUNCIONA:
        // 1. O Supabase adiciona tokens especiais na URL (#access_token=...)
        // 2. Verificamos se esses tokens existem
        // 3. Se sim, permitimos a redefini√ß√£o da senha
        // 4. Se n√£o, mostramos mensagem de erro
        //
        // ================================================================================

        const formResetPassword = document.getElementById('formResetPassword');
        const resetFormDiv = document.getElementById('resetForm');
        const successMessageDiv = document.getElementById('successMessage');
        const errorMessageDiv = document.getElementById('errorMessage');

        // ================================================================================
        // VERIFICAR SE O LINK √â V√ÅLIDO AO CARREGAR A P√ÅGINA
        // ================================================================================
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üîç Verificando link de recupera√ß√£o...');
            
            // O Supabase adiciona um hash na URL com o access_token
            // Exemplo: #access_token=xxx&type=recovery
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = hashParams.get('access_token');
            const type = hashParams.get('type');
            
            console.log('Hash params:', { accessToken: accessToken ? 'presente' : 'ausente', type });
            
            // Verificar se √© um link de recupera√ß√£o v√°lido
            if (!accessToken || type !== 'recovery') {
                console.error('‚ùå Link inv√°lido ou expirado');
                resetFormDiv.style.display = 'none';
                errorMessageDiv.style.display = 'block';
                lucide.createIcons();
                return;
            }
            
            console.log('‚úÖ Link v√°lido detectado');
            
            // Inicializar √≠cones
            lucide.createIcons();
        });

        // ================================================================================
        // SUBMIT DO FORMUL√ÅRIO DE REDEFINI√á√ÉO
        // ================================================================================
        formResetPassword.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validar senhas
            if (newPassword !== confirmPassword) {
                alert('‚ùå As senhas n√£o coincidem!');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('‚ùå A senha deve ter pelo menos 6 caracteres');
                return;
            }
            
            console.log('üîë Atualizando senha...');
            
            // Desabilitar bot√£o durante o processo
            const submitBtn = formResetPassword.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>Atualizando...</span>';
            
            try {
                // Chamar fun√ß√£o de atualiza√ß√£o de senha
                const resultado = await atualizarSenha(newPassword);
                
                if (resultado.success) {
                    // Sucesso!
                    console.log('‚úÖ Senha atualizada com sucesso');
                    resetFormDiv.style.display = 'none';
                    successMessageDiv.style.display = 'block';
                    lucide.createIcons();
                    
                } else {
                    // Erro
                    alert(`‚ùå Erro ao atualizar senha:\n${resultado.message}`);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    lucide.createIcons();
                }
                
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro inesperado ao atualizar senha');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                lucide.createIcons();
            }
        });
    </script>
</body>
</html>
